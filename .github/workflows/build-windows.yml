name: Build Windows Release

on:
  push:
    tags: ['v*']
    branches: ['main']
  pull_request:
    branches: ['main']
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  test:
    name: Test Import and Basic Functionality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.10
    
    - name: Install dependencies
      run: uv sync
    
    - name: Run import tests
      run: |
        # GUIç’°å¢ƒãªã—ã§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        uv run python -c "
        import sys
        sys.path.insert(0, 'src')
        
        # åŸºæœ¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        from audio_separator.gui.models.gui_model import AudioSeparationModel
        from audio_separator.gui.controllers.separation_controller import SeparationController
        from audio_separator.gui.components.file_selector import FileSelector
        
        print('âœ… All imports successful')
        
        # ãƒ¢ãƒ‡ãƒ«åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        model = AudioSeparationModel()
        print(f'âœ… Model initialized with {len(model.separation_params)} parameters')
        "

  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.10
    
    - name: Install dependencies
      run: uv sync
    
    - name: Add Nuitka
      run: uv add --dev nuitka
    
    - name: Build executable
      run: |
        uv run python nuitka_build.py --build
    
    - name: Test executable
      run: |
        # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if (Test-Path "dist/toyosatomimi.exe") {
          Write-Host "âœ… Executable created successfully"
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
          $size = (Get-Item "dist/toyosatomimi.exe").Length / 1MB
          Write-Host "ğŸ“¦ File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Executable not found"
          exit 1
        }
    
    - name: Create portable package
      run: |
        # ãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
        New-Item -ItemType Directory -Path "toyosatomimi-portable" -Force
        Copy-Item "dist/toyosatomimi.exe" "toyosatomimi-portable/"
        Copy-Item "README.md" "toyosatomimi-portable/README.txt"
        Copy-Item "LICENSE" "toyosatomimi-portable/LICENSE.txt"
        
        # è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if (Test-Path "config") {
          Copy-Item "config" "toyosatomimi-portable/" -Recurse
        }
        
        # ZIPåœ§ç¸®
        Compress-Archive -Path "toyosatomimi-portable/*" -DestinationPath "toyosatomimi-windows-portable.zip"
    
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: toyosatomimi-windows-exe
        path: dist/toyosatomimi.exe
        retention-days: 30
    
    - name: Upload portable package
      uses: actions/upload-artifact@v4
      with:
        name: toyosatomimi-windows-portable
        path: toyosatomimi-windows-portable.zip
        retention-days: 30
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/toyosatomimi.exe
          toyosatomimi-windows-portable.zip
        body: |
          ## toyosatomimi ${{ github.ref_name }}
          
          éŸ³å£°åˆ†é›¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ Windowsç‰ˆ
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - `toyosatomimi.exe` - ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
          - `toyosatomimi-windows-portable.zip` - ãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆï¼ˆæ¨å¥¨ï¼‰
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. `toyosatomimi.exe`ã‚’å®Ÿè¡Œ
          3. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦åˆ†é›¢é–‹å§‹
          
          ### âš ï¸ è¦ä»¶
          - Windows 10/11 (64-bit)
          - ãƒ¡ãƒ¢ãƒª: 8GBä»¥ä¸Šæ¨å¥¨
          - GPU: NVIDIA GPUï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€å‡¦ç†é«˜é€ŸåŒ–ï¼‰
          
          ### ğŸ”§ ä¸»ãªæ©Ÿèƒ½
          - BGMåˆ†é›¢ï¼ˆDemucsï¼‰
          - è©±è€…åˆ†é›¢ï¼ˆpyannote-audioï¼‰
          - GPUåŠ é€Ÿå¯¾å¿œ
          - è¤‡æ•°å‡ºåŠ›å½¢å¼å¯¾å¿œ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-dev:
    name: Build Development Version
    runs-on: windows-latest
    needs: test
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.10
    
    - name: Install dependencies
      run: uv sync
    
    - name: Add Nuitka
      run: uv add --dev nuitka
    
    - name: Build executable
      run: |
        uv run python nuitka_build.py --build
    
    - name: Upload development build
      uses: actions/upload-artifact@v4
      with:
        name: toyosatomimi-dev-build
        path: dist/toyosatomimi.exe
        retention-days: 7